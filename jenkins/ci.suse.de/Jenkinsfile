pipeline {
    agent any
    stages {
        stage('Set up cloud nodes') {
            steps {
                echo "Setting up nodes"
            }
        }
        stage('Check pull request') {
            agent {
                label 'cloud-testbuild-pr'
            }
            steps {
                sh "scripts/crowbar-testbuild.rb -o ${ghorg} -r ${ghrepo} -p ${pr_str} -c scripts/ardana-testbuild.yaml"
                /* scp to deployer node */
                /* run tests */
                echo "Tests passed!"
            }
        }
        stage('Run tests') {
            steps {
              script {
                  waitUntil {
                      def merged = false
                      try {
                          sh "python jenkins/ci.suse.de/check-if-merged.py ${ghorg} ${ghrepo} ${pr_str}"
                          merged = true
                      } catch {
                          merged = false
                      }
                      return merged
                  }
              }
              echo "The pull request merged!"
            }
        }
        stage('Submit to OBS') {
            steps {
                echo "Done"
            }
        }
    }
}
